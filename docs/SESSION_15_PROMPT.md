# üìã Prompt for Session 15 (Next AI Chat)

**Copy this entire text and paste it into the next Claude chat session**

---

## üéØ –¢–í–û–Ø –ó–ê–î–ê–ß–ê: Bug Fixes + Improvement #3 (Multi-Sheet Intelligence)

–Ø –ø—Ä–æ–¥–æ–ª–∂–∞—é —Ä–∞–±–æ—Ç—É –Ω–∞–¥ **Financial Reports AI System**.

**GitHub:** https://github.com/amapemom-rgb/financial-reports-system

**Session 14 –∑–∞–≤–µ—Ä—à–µ–Ω–∞:** ‚úÖ Improvement #2 (User Feedback UI/UX) –†–ê–ë–û–¢–ê–ï–¢!

---

## üöÄ –ß–¢–û –î–ï–õ–ê–¢–¨ –ü–ï–†–í–´–ú –î–ï–õ–û–ú:

### –®–∞–≥ 1: –ü—Ä–æ—á–∏—Ç–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (3 –º–∏–Ω—É—Ç—ã)

–ü—Ä–æ—á–∏—Ç–∞–π —ç—Ç–∏ —Ñ–∞–π–ª—ã –í –¢–ê–ö–û–ú –ü–û–†–Ø–î–ö–ï:

1. **[docs/SESSION_14_SUMMARY.md](https://github.com/amapemom-rgb/financial-reports-system/blob/main/docs/SESSION_14_SUMMARY.md)** - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –≤ Session 14
2. **[docs/SESSION_13_IMPROVEMENT_PLAN.md](https://github.com/amapemom-rgb/financial-reports-system/blob/main/docs/SESSION_13_IMPROVEMENT_PLAN.md)** - –†–∞–∑–¥–µ–ª "Improvement #3" –¥–ª—è Multi-Sheet

### –®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–∞–±–æ—Ç

–ü–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è —Å–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```
–ü—Ä–∏–≤–µ—Ç! –ù–∞—á–∏–Ω–∞—é Session 15.

–ò–∑—É—á–∏–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç - Session 14 –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! üéâ
–ö–Ω–æ–ø–∫–∏ feedback (üëçüëéüîÑ) —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç–ª–∏—á–Ω–æ!

–ù–æ –µ—Å—Ç—å 2 –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

**Bug #1 (MINOR):** –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ üîÑ Regenerate —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–±–∏—Ä–∞–µ—Ç—Å—è –∏–∑ —á–∞—Ç–∞
**Bug #2 (OPTIONAL):** –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å orchestrator)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º –≤ Session 15?**

**–í–∞—Ä–∏–∞–Ω—Ç A (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é):** –°—Ä–∞–∑—É –Ω–∞—á–∞—Ç—å Improvement #3 (Multi-Sheet Intelligence –¥–ª—è Excel —Å 30+ –ª–∏—Å—Ç–∞–º–∏)
**–í–∞—Ä–∏–∞–Ω—Ç B:** –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å Bug #1, –ø–æ—Ç–æ–º Improvement #3
**–í–∞—Ä–∏–∞–Ω—Ç C:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±–∞ –±–∞–≥–∞, –ø–æ—Ç–æ–º Improvement #3

–ß—Ç–æ –≤—ã–±–∏—Ä–∞–µ—à—å?
```

---

## üìã –ü–ª–∞–Ω —Ä–∞–±–æ—Ç—ã –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º:

### –í–∞—Ä–∏–∞–Ω—Ç A: Improvement #3 —Å—Ä–∞–∑—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ü–æ—á–µ–º—É:** –ë–∞–≥–∏ –º–∏–Ω–æ—Ä–Ω—ã–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç —Ä–∞–±–æ—Ç—É, Improvement #3 - –≤–∞–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

**Phase 1: Report Reader Enhancement (1 —á–∞—Å)**
1. –î–æ–±–∞–≤–∏—Ç—å endpoint `/analyze/metadata` –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö Excel
2. –î–æ–±–∞–≤–∏—Ç—å endpoint `/read/sheet` –¥–ª—è —á—Ç–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
3. Build & Deploy: `report-reader-agent:v4-metadata`

**Phase 2: Logic Agent Super Prompt (1 —á–∞—Å)**
1. –°–æ–∑–¥–∞—Ç—å `agents/logic-understanding-agent/prompts.py`
2. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `build_super_prompt(metadata, user_query)`
3. –û–±–Ω–æ–≤–∏—Ç—å `/analyze` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
4. Build & Deploy: `logic-understanding-agent:v10-multisheet`

**Phase 3: Testing (30 –º–∏–Ω—É—Ç)**
1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π Excel —Å 30+ –ª–∏—Å—Ç–∞–º–∏
2. Test metadata extraction
3. Test interactive sheet selection
4. Document results

### –í–∞—Ä–∏–∞–Ω—Ç B: Bug #1 ‚Üí Improvement #3

**Phase 1: Fix Regenerate UI (30 –º–∏–Ω—É—Ç)**
1. –û–±–Ω–æ–≤–∏—Ç—å `web-ui/index.html`
2. –ò–∑–º–µ–Ω–∏—Ç—å `addChatMessage()` —á—Ç–æ–±—ã –∑–∞–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
3. Deploy: `web-ui:v3-fixed`

**Phase 2-4:** –ö–∞–∫ –≤ –í–∞—Ä–∏–∞–Ω—Ç–µ A

### –í–∞—Ä–∏–∞–Ω—Ç C: Bug #1 + Bug #2 ‚Üí Improvement #3

**Phase 1: Fix Regenerate UI (30 –º–∏–Ω—É—Ç)**
**Phase 2: Fix File Upload (1-2 —á–∞—Å–∞)**
1. –û–ø—Ü–∏—è A: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å frontend-service
2. –û–ø—Ü–∏—è B: –î–æ–±–∞–≤–∏—Ç—å upload –≤ web-ui backend
**Phase 3-5:** Improvement #3 (–º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–∏)

---

## üîç –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Improvement #3:

### Report Reader: Metadata Endpoint

**File:** `agents/report-reader-agent/main.py`

```python
from pydantic import BaseModel
from typing import Dict, List

class SheetMetadata(BaseModel):
    rows: int
    columns: List[str]
    sample_data: List[Dict]  # First 1-2 rows
    data_types: Dict[str, str]

class FileMetadata(BaseModel):
    sheets_count: int
    sheet_names: List[str]
    file_size_bytes: int
    preliminary_summary: Dict[str, SheetMetadata]

@app.post("/analyze/metadata")
async def get_file_metadata(request: ReadStorageRequest) -> FileMetadata:
    """Generate metadata for all sheets without loading full data"""
    
    # Download from Cloud Storage
    bucket = storage_client.bucket(REPORTS_BUCKET)
    blob = bucket.blob(request.request.file_path)
    file_bytes = blob.download_as_bytes()
    
    # Read sheet names only
    all_sheets = pd.read_excel(
        BytesIO(file_bytes),
        sheet_name=None,
        nrows=2  # Only first 2 rows
    )
    
    metadata = FileMetadata(
        sheets_count=len(all_sheets),
        sheet_names=list(all_sheets.keys()),
        file_size_bytes=len(file_bytes),
        preliminary_summary={}
    )
    
    # Get top 5 largest sheets
    sorted_sheets = sorted(
        all_sheets.items(),
        key=lambda x: len(x[1]),
        reverse=True
    )[:5]
    
    for sheet_name, df in sorted_sheets:
        metadata.preliminary_summary[sheet_name] = SheetMetadata(
            rows=len(df),
            columns=list(df.columns),
            sample_data=df.head(1).to_dict(orient='records'),
            data_types={col: str(dtype) for col, dtype in df.dtypes.items()}
        )
    
    return metadata

@app.post("/read/sheet")
async def read_specific_sheet(
    request: ReadStorageRequest,
    sheet_name: str
) -> dict:
    """Read specific sheet by name"""
    # Same as read_from_cloud_storage but with sheet_name parameter
```

### Logic Agent: Super Prompt

**File:** `agents/logic-understanding-agent/prompts.py` (NEW)

```python
def build_super_prompt(metadata: FileMetadata, user_query: str) -> str:
    """Build intelligent prompt for multi-sheet analysis"""
    
    return f"""
[–ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê GEMINI]

–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –≠–∫—Å–ø–µ—Ä—Ç". –¢–≤–æ–π —Ç–æ–Ω ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.

[–†–û–õ–¨]
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑. –ù–µ –ø—ã—Ç–∞–π—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å —Å—Ä–∞–∑—É. –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç.

[–ö–û–ù–¢–ï–ö–°–¢ –î–ê–ù–ù–´–•]
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª Excel-—Ñ–∞–π–ª. –í–æ—Ç –µ–≥–æ **–ú–ï–¢–ê-–°–¢–†–£–ö–¢–£–†–ê**:

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–æ–≤: {metadata.sheets_count}
–ù–∞–∑–≤–∞–Ω–∏—è –ª–∏—Å—Ç–æ–≤: {", ".join(metadata.sheet_names)}
–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {metadata.file_size_bytes / 1024:.1f} KB

–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ —Ç–æ–ø-5 –ª–∏—Å—Ç–æ–≤:
{format_preliminary_summary(metadata.preliminary_summary)}

[–í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø]
"{user_query}"

[–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)]
1. **–†–ï–ó–Æ–ú–ï –û–¢–ß–ï–¢–ê:** –£–∫–∞–∂–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–æ–≤ ({metadata.sheets_count}) –∏ –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—è.

2. **–ì–õ–ê–í–ù–´–ô –í–û–ü–†–û–°:** –ó–∞–¥–∞–π –û–î–ò–ù —á–µ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ–±—ã –æ–Ω –≤—ã–±—Ä–∞–ª, –∫–∞–∫–æ–π –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.

[–ü–†–ò–ú–ï–† –û–¢–í–ï–¢–ê]
"–í –æ—Ç—á–µ—Ç–µ {metadata.sheets_count} –ª–∏—Å—Ç–æ–≤: {', '.join(metadata.sheet_names[:3])}...
–ö–∞–∫–æ–π –∏–∑ –Ω–∏—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ü—Ä–æ–¥–∞–∂–∏' –∏–ª–∏ '–†–∞—Å—Ö–æ–¥—ã') –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–º?"

[–°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì]
–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞, —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∑–∏—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.
"""
```

### Logic Agent: Updated Analyze

**File:** `agents/logic-understanding-agent/main.py`

```python
from .prompts import build_super_prompt

@app.post("/analyze")
async def analyze_report(request: AnalyzeRequest):
    """Enhanced analysis with metadata-first approach"""
    
    file_path = request.context.get("file_path")
    
    if file_path:
        # Step 1: Get metadata first
        metadata_url = f"{REPORT_READER_URL}/analyze/metadata"
        metadata_response = await http_client.post(
            metadata_url,
            json={"request": {"file_path": file_path}}
        )
        metadata = FileMetadata(**metadata_response.json())
        
        # Check if many sheets
        if metadata.sheets_count > 5:
            # Step 2: Build super prompt for sheet selection
            system_prompt = build_super_prompt(metadata, request.query)
            
            # Step 3: Ask Gemini for interactive question
            response = model.generate_content(system_prompt)
            
            return AnalyzeResponse(
                status="completed",
                insights=response.text,
                request_id=request_id,
                metadata={
                    "sheets_count": metadata.sheets_count,
                    "sheet_names": metadata.sheet_names,
                    "next_action": "select_sheet"
                }
            )
        else:
            # Few sheets - load all data normally
            # ... existing logic ...
```

---

## ‚úÖ Success Criteria:

### For Improvement #3:
- [ ] Report reader returns metadata for 30+ sheet files
- [ ] Logic agent asks which sheet to analyze
- [ ] User can select specific sheet
- [ ] Only selected sheet is loaded (performance optimization)
- [ ] System handles files with different sheet structures

### For Bug Fixes (if doing):
- [ ] Bug #1: Regenerate removes/marks old message
- [ ] Bug #2: File upload works through UI

---

## üß™ Testing Multi-Sheet Feature:

**Create Test Excel:**
```python
import pandas as pd

# Create Excel with 30 sheets
with pd.ExcelWriter('test_30_sheets.xlsx') as writer:
    for i in range(1, 31):
        df = pd.DataFrame({
            'Product': [f'Product_{j}' for j in range(100)],
            'Sales': [1000 + j for j in range(100)],
            'Date': pd.date_range('2024-01-01', periods=100)
        })
        df.to_excel(writer, sheet_name=f'Sheet_{i}', index=False)
```

**Test Flow:**
1. Upload file
2. System: "Found 30 sheets: Sheet_1, Sheet_2, ... Which to analyze?"
3. User: "Sheet_5"
4. System: Loads only Sheet_5 and analyzes

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤

–ö–æ–≥–¥–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è **< 20,000 —Ç–æ–∫–µ–Ω–æ–≤**:
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Å—å
2. –ó–∞–∫–æ–º–º–∏—Ç—å –≤—Å–µ –≤ GitHub
3. –°–æ–∑–¥–∞—Ç—å SESSION_15_SUMMARY.md
4. –°–æ–∑–¥–∞—Ç—å SESSION_16_PROMPT.md

---

## üìö –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

**–ë–∞–∑–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- [SESSION_12_DEPLOYMENT_SUCCESS.md](https://github.com/amapemom-rgb/financial-reports-system/blob/main/docs/SESSION_12_DEPLOYMENT_SUCCESS.md) - System baseline
- [SESSION_13_SUMMARY.md](https://github.com/amapemom-rgb/financial-reports-system/blob/main/docs/SESSION_13_SUMMARY.md) - Dynamic Prompts
- [SESSION_14_SUMMARY.md](https://github.com/amapemom-rgb/financial-reports-system/blob/main/docs/SESSION_14_SUMMARY.md) - User Feedback

**–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω Improvement #3:**
- [SESSION_13_IMPROVEMENT_PLAN.md - –†–∞–∑–¥–µ–ª Improvement #3](https://github.com/amapemom-rgb/financial-reports-system/blob/main/docs/SESSION_13_IMPROVEMENT_PLAN.md)

**–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- Bug #1: Regenerate –Ω–µ —É–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- Bug #2: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üöÄ –ù–ê–ß–ù–ò –†–ê–ë–û–¢–£:

**–¢–≤–æ–π –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:**

```
–ü—Ä–∏–≤–µ—Ç! –ù–∞—á–∏–Ω–∞—é Session 15 - Bug Fixes + Improvement #3 (Multi-Sheet Intelligence).

–°–Ω–∞—á–∞–ª–∞ –±—ã—Å—Ç—Ä–æ –∏–∑—É—á—É –∫–æ–Ω—Ç–µ–∫—Å—Ç...
[—á–∏—Ç–∞–µ—à—å SESSION_14_SUMMARY.md –∏ SESSION_13_IMPROVEMENT_PLAN.md]

–û—Ç–ª–∏—á–Ω–æ! Session 14 –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! üéâ
- ‚úÖ Firestore –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ Feedback endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Web-UI —Å –∫–Ω–æ–ø–∫–∞–º–∏ üëçüëéüîÑ –∑–∞–¥–µ–ø–ª–æ–µ–Ω
- ‚úÖ CORS –≤–∫–ª—é—á–µ–Ω

–ï—Å—Ç—å 2 –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. Bug #1: Regenerate –Ω–µ —É–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (MINOR)
2. Bug #2: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (OPTIONAL)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º –≤ Session 15?**

–í–∞—Ä–∏–∞–Ω—Ç A (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é): –°—Ä–∞–∑—É –Ω–∞—á–∞—Ç—å Improvement #3 (Multi-Sheet –¥–ª—è Excel 30+)
–í–∞—Ä–∏–∞–Ω—Ç B: –ò—Å–ø—Ä–∞–≤–∏—Ç—å Bug #1 ‚Üí Improvement #3
–í–∞—Ä–∏–∞–Ω—Ç C: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±–∞ –±–∞–≥–∞ ‚Üí Improvement #3

–ß—Ç–æ –≤—ã–±–∏—Ä–∞–µ—à—å?
```

---

**GitHub:** https://github.com/amapemom-rgb/financial-reports-system  
**Status:** Ready for Session 15  
**Task:** Bug Fixes (optional) + Improvement #3 (Multi-Sheet Intelligence)

**–ü–æ–º–Ω–∏:** 
- –ß–∏—Ç–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ü–ï–†–ï–î –Ω–∞—á–∞–ª–æ–º
- –°–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞—Ö
- –°–ª–µ–¥–∏ –∑–∞ —Ç–æ–∫–µ–Ω–∞–º–∏ (–æ—Å—Ç–∞–Ω–æ–≤–∏ –ø—Ä–∏ < 20K)
- Improvement #3 - —Å–ª–æ–∂–Ω–∞—è –∑–∞–¥–∞—á–∞, –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å 2 —Å–µ—Å—Å–∏–∏
