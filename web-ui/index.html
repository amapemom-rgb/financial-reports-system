<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reports Analysis System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .error-banner {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        /* Feedback buttons styles */
        .feedback-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .feedback-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .feedback-btn:hover {
            transform: scale(1.05);
        }
        .feedback-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-like {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgb(34, 197, 94);
        }
        .btn-like:hover {
            background: rgba(34, 197, 94, 0.3);
        }
        .btn-dislike {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgb(239, 68, 68);
        }
        .btn-dislike:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        .btn-regenerate {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgb(59, 130, 246);
        }
        .btn-regenerate:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        /* Regenerated message styles */
        .regenerated-message {
            opacity: 0.5;
            position: relative;
            border-left: 3px solid rgba(59, 130, 246, 0.5) !important;
            padding-left: 8px !important;
        }

        .regenerated-label {
            position: absolute;
            top: -8px;
            right: 8px;
            background: rgba(59, 130, 246, 0.3);
            color: rgb(147, 197, 253);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="min-h-screen text-white p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                Financial Reports Analysis System
            </h1>
            <p class="text-gray-400">–ê–Ω–∞–ª–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é AI ü§ñ <span class="text-xs text-green-400">(v10-upload-fix)</span></p>
        </div>

        <!-- Error Banner (hidden by default) -->
        <div id="errorBanner" class="hidden error-banner bg-red-900/50 border-2 border-red-500 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
                <span class="text-2xl">‚ö†Ô∏è</span>
                <div class="flex-1">
                    <h3 class="font-bold text-lg mb-1">–ü—Ä–æ–±–ª–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞</h3>
                    <div id="errorDetails" class="text-sm text-gray-300"></div>
                    <div id="errorSolution" class="mt-2 text-sm bg-red-900/50 p-3 rounded"></div>
                </div>
                <button onclick="hideError()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
        </div>

        <!-- Token Input -->
        <div class="bg-gray-800 rounded-lg p-4 md:p-6 mb-6 border border-gray-700">
            <label class="block text-sm font-medium mb-2">
                üîê Auth Token
            </label>
            <div class="text-xs text-gray-400 mb-2">
                –ü–æ–ª—É—á–∏ —á–µ—Ä–µ–∑: <code class="bg-gray-900 px-2 py-1 rounded">gcloud auth print-identity-token</code>
            </div>
            <input
                type="password"
                id="tokenInput"
                placeholder="–í—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω —Å—é–¥–∞..."
                class="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 text-white focus:border-blue-500 focus:outline-none"
            />
            <div id="tokenStatus" class="mt-2 text-sm hidden"></div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Left Column: Status & Upload -->
            <div class="space-y-6">
                <!-- Service Status -->
                <div class="bg-gray-800 rounded-lg p-4 md:p-6 border border-gray-700">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-2xl">üè•</span>
                        <h2 class="text-xl font-semibold">–°—Ç–∞—Ç—É—Å</h2>
                    </div>
                    <button
                        id="checkServicesBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white font-medium py-2 px-4 rounded transition text-sm"
                    >
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
                    </button>
                    <div id="servicesStatus" class="mt-4 space-y-2"></div>
                </div>

                <!-- File Upload -->
                <div class="bg-gray-800 rounded-lg p-4 md:p-6 border border-gray-700">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-2xl">üì§</span>
                        <h2 class="text-xl font-semibold">–§–∞–π–ª</h2>
                    </div>
                    <label class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded transition flex items-center justify-center gap-2 cursor-pointer text-sm">
                        üìÅ CSV / Excel
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="hidden" />
                    </label>
                    <div id="uploadStatus" class="mt-4 hidden"></div>
                </div>
            </div>

            <!-- Middle & Right Column: Chat -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 rounded-lg border border-gray-700 h-full flex flex-col">
                    <!-- Chat Header -->
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üí¨</span>
                            <h2 class="text-xl font-semibold">AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h2>
                        </div>
                        <button id="clearChatBtn" onclick="clearChat()" class="text-sm text-gray-400 hover:text-white">
                            –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chatMessages" class="flex-1 p-4 space-y-4 overflow-y-auto" style="min-height: 400px; max-height: 500px;">
                        <div class="text-center text-gray-400 py-8">
                            <div class="text-4xl mb-2">ü§ñ</div>
                            <div class="text-sm">–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã.</div>
                            <div class="text-xs mt-2 text-gray-500">–ó–∞–≥—Ä—É–∑–∏ —Ñ–∞–π–ª –∏ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å</div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="p-4 border-t border-gray-700">
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="chatInput"
                                placeholder="–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å..."
                                class="flex-1 bg-gray-900 border border-gray-700 rounded px-4 py-2 text-white focus:border-blue-500 focus:outline-none"
                                onkeypress="if(event.key==='Enter') sendMessage()"
                            />
                            <button
                                id="sendBtn"
                                onclick="sendMessage()"
                                class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white font-medium px-6 py-2 rounded transition"
                            >
                                ‚û§
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Console -->
        <div class="bg-gray-800 rounded-lg border border-gray-700">
            <div class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-750" onclick="toggleLogs()">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üíª</span>
                    <h2 class="text-xl font-semibold">–ö–æ–Ω—Å–æ–ª—å –ª–æ–≥–æ–≤</h2>
                    <span class="text-sm text-gray-400">(<span id="logCount">0</span>)</span>
                </div>
                <button id="toggleLogsBtn" class="text-gray-400 hover:text-white">‚ñº</button>
            </div>
            <div id="logsContainer" class="p-4 pt-0">
                <div id="logsContent" class="bg-gray-900 rounded p-4 max-h-96 overflow-auto space-y-1 font-mono text-sm">
                    <div class="text-gray-500 text-sm">–õ–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç...</div>
                </div>
                <button onclick="clearLogs()" class="mt-3 text-sm text-gray-400 hover:text-white">
                    –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="mt-6 bg-blue-900/20 border border-blue-800 rounded-lg p-4 text-sm">
            <h3 class="font-semibold mb-2">üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h3>
            <ol class="text-gray-300 space-y-1 list-decimal list-inside">
                <li>–ü–æ–ª—É—á–∏ —Ç–æ–∫–µ–Ω: <code class="bg-gray-800 px-2 py-1 rounded text-xs">gcloud auth print-identity-token</code></li>
                <li>–í—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω –≤ –ø–æ–ª–µ –≤—ã—à–µ ‚òùÔ∏è</li>
                <li>–ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤</li>
                <li>–ó–∞–≥—Ä—É–∑–∏ CSV –∏–ª–∏ Excel —Ñ–∞–π–ª üìä</li>
                <li>–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –≤ —á–∞—Ç–µ üí¨</li>
                <li><span class="text-green-400">NEW:</span> –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ üëçüëéüîÑ –¥–ª—è —Ñ–∏–¥–±—ç–∫–∞</li>
                <li><span class="text-orange-400">Session 20:</span> Secure file upload via Signed URLs</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = 'https://frontend-service-38390150695.us-central1.run.app';
        const LOGIC_AGENT_URL = 'https://logic-understanding-agent-38390150695.us-central1.run.app';
        let logs = [];
        let uploadedFile = null;
        let conversationId = null;
        let logsExpanded = true;
        let currentRequestId = null;

        // ==================== Logging ====================
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ timestamp, message, type });
            
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            
            const logsContent = document.getElementById('logsContent');
            if (logs.length === 1) logsContent.innerHTML = '';
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type];
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            logsContent.appendChild(logEntry);
            
            document.getElementById('logCount').textContent = logs.length;
            logsContent.scrollTop = logsContent.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${timestamp}: ${message}`);
        }

        function clearLogs() {
            logs = [];
            document.getElementById('logsContent').innerHTML = '<div class="text-gray-500 text-sm">–õ–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç...</div>';
            document.getElementById('logCount').textContent = '0';
        }

        function toggleLogs() {
            logsExpanded = !logsExpanded;
            document.getElementById('logsContainer').style.display = logsExpanded ? 'block' : 'none';
            document.getElementById('toggleLogsBtn').textContent = logsExpanded ? '‚ñº' : '‚ñ∂';
        }

        // ==================== Error Handling ====================
        function showError(component, code, details, solution) {
            const banner = document.getElementById('errorBanner');
            document.getElementById('errorDetails').innerHTML = `
                <div><strong>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:</strong> ${component}</div>
                <div><strong>–ö–æ–¥ –æ—à–∏–±–∫–∏:</strong> ${code}</div>
                <div class="mt-1">${details}</div>
            `;
            document.getElementById('errorSolution').innerHTML = `
                <div class="font-semibold mb-1">üí° –†–µ—à–µ–Ω–∏–µ:</div>
                <div>${solution}</div>
            `;
            banner.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorBanner').classList.add('hidden');
        }

        function diagnoseError(error, context = '') {
            if (error.includes('401') || error.includes('403') || error.includes('Forbidden')) {
                showError(
                    context || 'API',
                    'HTTP 403',
                    '–¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π',
                    '1. –í—ã–ø–æ–ª–Ω–∏: <code class="bg-gray-900 px-2 py-1 rounded">gcloud auth print-identity-token</code><br>2. –°–∫–æ–ø–∏—Ä—É–π –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω<br>3. –í—Å—Ç–∞–≤—å –≤ –ø–æ–ª–µ "Auth Token"'
                );
            } else if (error.includes('503') || error.includes('unavailable')) {
                showError(
                    context || '–°–µ—Ä–≤–∏—Å',
                    'HTTP 503',
                    '–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
                    '–ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ GCP Console –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç'
                );
            } else if (error.includes('timeout') || error.includes('000')) {
                showError(
                    context || '–°–µ—Ç—å',
                    'Connection Error',
                    '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É',
                    '–ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ —É–±–µ–¥–∏—Å—å —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã'
                );
            } else {
                showError(
                    context || '–°–∏—Å—Ç–µ–º–∞',
                    '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',
                    error,
                    '–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –Ω–∏–∂–µ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π'
                );
            }
        }

        function getToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                addLog('–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'error');
                diagnoseError('–¢–æ–∫–µ–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'Auth');
                return null;
            }
            return token;
        }

        // ==================== Token ====================
        document.getElementById('tokenInput').addEventListener('input', (e) => {
            const status = document.getElementById('tokenStatus');
            if (e.target.value.trim()) {
                status.textContent = '‚úÖ –¢–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                status.className = 'mt-2 text-green-400 text-sm';
                status.classList.remove('hidden');
                hideError();
            } else {
                status.classList.add('hidden');
            }
        });

        // ==================== Services Check ====================
        document.getElementById('checkServicesBtn').addEventListener('click', async () => {
            addLog('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...', 'info');
            const btn = document.getElementById('checkServicesBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';

            const serviceUrls = {
                frontend: 'https://frontend-service-38390150695.us-central1.run.app',
                orchestrator: 'https://orchestrator-agent-38390150695.us-central1.run.app',
                reader: 'https://report-reader-agent-38390150695.us-central1.run.app',
                logic: 'https://logic-understanding-agent-38390150695.us-central1.run.app',
                visualization: 'https://visualization-agent-38390150695.us-central1.run.app'
            };

            const statusDiv = document.getElementById('servicesStatus');
            statusDiv.innerHTML = '';

            for (const [name, url] of Object.entries(serviceUrls)) {
                try {
                    const response = await fetch(`${url}/health`);
                    
                    const statusItem = document.createElement('div');
                    statusItem.className = 'flex items-center justify-between bg-gray-900 p-2 rounded text-sm';
                    
                    if (response.ok) {
                        statusItem.innerHTML = `<span class="capitalize">${name}</span><span class="text-green-400">‚úÖ healthy</span>`;
                        addLog(`‚úÖ ${name}: healthy`, 'success');
                    } else {
                        statusItem.innerHTML = `<span class="capitalize">${name}</span><span class="text-red-400">‚ùå HTTP ${response.status}</span>`;
                        addLog(`‚ùå ${name}: HTTP ${response.status}`, 'error');
                    }
                    statusDiv.appendChild(statusItem);
                } catch (error) {
                    const statusItem = document.createElement('div');
                    statusItem.className = 'flex items-center justify-between bg-gray-900 p-2 rounded text-sm';
                    statusItem.innerHTML = `<span class="capitalize">${name}</span><span class="text-red-400">‚ùå error</span>`;
                    statusDiv.appendChild(statusItem);
                    addLog(`‚ùå ${name}: ${error.message}`, 'error');
                }
            }

            btn.disabled = false;
            btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã';
            addLog('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        });

        // ==================== File Upload (Session 20: Signed URL Pattern) ====================
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            addLog(`üì§ –ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞: ${file.name}`, 'info');

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.classList.remove('hidden');

            try {
                // ===== Step 1: Request Signed URL from Backend =====
                statusDiv.innerHTML = `
                    <div class="bg-gray-900 p-3 rounded">
                        <div class="text-blue-400 text-sm mb-1">‚è≥ –®–∞–≥ 1/3: –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É...</div>
                        <div class="text-xs text-gray-400">${file.name}</div>
                    </div>
                `;
                
                addLog(`Step 1: Requesting signed URL for ${file.name}`, 'info');

                const signedUrlResponse = await fetch(`${LOGIC_AGENT_URL}/upload/signed-url`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        content_type: file.type || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    })
                });

                if (!signedUrlResponse.ok) {
                    const error = await signedUrlResponse.text();
                    throw new Error(`Failed to get signed URL: ${error}`);
                }

                const signedData = await signedUrlResponse.json();
                addLog(`‚úÖ Signed URL –ø–æ–ª—É—á–µ–Ω (expires in ${signedData.expires_in_minutes} min)`, 'success');
                addLog(`File ID: ${signedData.file_id}`, 'info');

                // ===== Step 2: Upload File Directly to GCS =====
                statusDiv.innerHTML = `
                    <div class="bg-gray-900 p-3 rounded">
                        <div class="text-blue-400 text-sm mb-1">‚è≥ –®–∞–≥ 2/3: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ Cloud Storage...</div>
                        <div class="text-xs text-gray-400">${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</div>
                        <div class="mt-2 bg-gray-800 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 33%"></div>
                        </div>
                    </div>
                `;

                addLog(`Step 2: Uploading file to GCS via signed URL`, 'info');

                const uploadResponse = await fetch(signedData.upload_url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': file.type || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    },
                    body: file
                });

                if (!uploadResponse.ok) {
                    throw new Error(`GCS upload failed: HTTP ${uploadResponse.status}`);
                }

                addLog(`‚úÖ File uploaded to GCS successfully`, 'success');

                // ===== Step 3: Notify Backend =====
                statusDiv.innerHTML = `
                    <div class="bg-gray-900 p-3 rounded">
                        <div class="text-blue-400 text-sm mb-1">‚è≥ –®–∞–≥ 3/3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏...</div>
                        <div class="text-xs text-gray-400">${file.name}</div>
                        <div class="mt-2 bg-gray-800 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 66%"></div>
                        </div>
                    </div>
                `;

                addLog(`Step 3: Notifying backend via /upload/complete`, 'info');

                const completeResponse = await fetch(`${LOGIC_AGENT_URL}/upload/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: signedData.file_id,
                        file_path: signedData.file_path
                    })
                });

                if (!completeResponse.ok) {
                    const error = await completeResponse.text();
                    throw new Error(`Upload verification failed: ${error}`);
                }

                const completeData = await completeResponse.json();
                addLog(`‚úÖ Upload verified: ${(completeData.file_size_bytes / 1024 / 1024).toFixed(2)} MB`, 'success');

                // ===== Success! =====
                uploadedFile = {
                    file_id: signedData.file_id,
                    file_path: signedData.file_path,
                    filename: file.name,
                    size_bytes: completeData.file_size_bytes
                };

                statusDiv.innerHTML = `
                    <div class="bg-gray-900 p-3 rounded border-2 border-green-500">
                        <div class="text-green-400 text-sm mb-1 font-semibold">‚úÖ ${file.name} –∑–∞–≥—Ä—É–∂–µ–Ω!</div>
                        <div class="text-xs text-gray-400 space-y-1">
                            <div>ID: ${signedData.file_id}</div>
                            <div>–†–∞–∑–º–µ—Ä: ${(completeData.file_size_bytes / 1024 / 1024).toFixed(2)} MB</div>
                            <div>–ü—É—Ç—å: ${signedData.file_path}</div>
                        </div>
                        <div class="mt-2 bg-gray-800 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                `;

                addLog(`üéâ File upload completed successfully!`, 'success');
                
                // Add welcome message to chat
                addChatMessage('ai', `–§–∞–π–ª "${file.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ —ç—Ç–æ–º—É –æ—Ç—á—ë—Ç—É.`);

            } catch (error) {
                addLog(`‚ùå Upload failed: ${error.message}`, 'error');
                
                statusDiv.innerHTML = `
                    <div class="bg-gray-900 p-3 rounded border-2 border-red-500">
                        <div class="text-red-400 text-sm mb-1 font-semibold">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        <div class="text-xs text-gray-300">${error.message}</div>
                    </div>
                `;

                diagnoseError(error.message, 'File Upload');
            }
        });

        // ==================== Chat ====================
        function addChatMessage(role, message, requestId = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const welcome = messagesDiv.querySelector('.text-center');
            if (welcome) welcome.remove();
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            msgDiv.dataset.requestId = requestId;
            
            let feedbackButtons = '';
            if (role === 'ai' && requestId) {
                feedbackButtons = `
                    <div class="feedback-buttons">
                        <button class="feedback-btn btn-like" onclick="sendFeedback('${requestId}', 'positive', this)">üëç Like</button>
                        <button class="feedback-btn btn-dislike" onclick="sendFeedback('${requestId}', 'negative', this)">üëé Dislike</button>
                        <button class="feedback-btn btn-regenerate" onclick="regenerateResponse('${requestId}', this)">üîÑ Regenerate</button>
                    </div>
                `;
            }
            
            msgDiv.innerHTML = `
                <div class="max-w-[80%] ${role === 'user' ? 'bg-blue-600' : 'bg-gray-700'} rounded-lg p-3">
                    <div class="text-xs text-gray-300 mb-1">${role === 'user' ? '–¢—ã' : 'ü§ñ AI'}</div>
                    <div class="text-sm whitespace-pre-wrap">${message}</div>
                    ${feedbackButtons}
                </div>
            `;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }


        // ==================== Feedback Functions ====================
        async function sendFeedback(requestId, feedbackType, button) {
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = '‚è≥';

            try {
                const response = await fetch(`${LOGIC_AGENT_URL}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request_id: requestId,
                        feedback_type: feedbackType
                    })
                });

                if (response.ok) {
                    button.textContent = feedbackType === 'positive' ? '‚úÖ' : '‚ùå';
                    addLog(`‚úÖ Feedback sent: ${feedbackType}`, 'success');
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    }, 2000);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog(`‚ùå Feedback error: ${error.message}`, 'error');
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        async function regenerateResponse(requestId, button) {
            button.disabled = true;
            button.textContent = '‚è≥ Regenerating...';

            // Find and mark old message as regenerated
            const oldMessage = document.querySelector(`[data-request-id="${requestId}"]`);
            if (oldMessage) {
                const messageContent = oldMessage.querySelector('.max-w-\\[80\\%\\]');
                if (messageContent) {
                    messageContent.classList.add('regenerated-message');
                    
                    const label = document.createElement('div');
                    label.className = 'regenerated-label';
                    label.textContent = 'üîÑ Regenerated';
                    messageContent.appendChild(label);
                    
                    const feedbackButtons = messageContent.querySelectorAll('.feedback-btn');
                    feedbackButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                    });
                    
                    addLog(`–°—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (${requestId}) –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ regenerated`, 'info');
                }
            }

            try {
                const response = await fetch(`${LOGIC_AGENT_URL}/regenerate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: requestId })
                });

                if (response.ok) {
                    const data = await response.json();
                    addChatMessage('ai', data.insights, data.request_id);
                    addLog('‚úÖ Response regenerated', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog(`‚ùå Regenerate error: ${error.message}`, 'error');
                addChatMessage('ai', `–ò–∑–≤–∏–Ω–∏, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üîÑ Regenerate';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage('user', message);
            addLog(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–æ–ø—Ä–æ—Å: ${message}`, 'info');
            input.value = '';
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = '‚è≥';
            
            try {
                // Include uploaded file context if available
                const requestBody = {
                    query: message
                };

                if (uploadedFile) {
                    requestBody.context = {
                        file_path: uploadedFile.file_path
                    };
                }

                const response = await fetch(`${LOGIC_AGENT_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentRequestId = data.request_id;
                    
                    addChatMessage('ai', data.insights, data.request_id);
                    addLog(`‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç (request_id: ${data.request_id})`, 'success');
                } else {
                    const error = await response.text();
                    addLog(`‚ùå –û—à–∏–±–∫–∞: HTTP ${response.status}`, 'error');
                    addChatMessage('ai', `–ò–∑–≤–∏–Ω–∏, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error}`);
                    diagnoseError(error, 'Chat');
                }
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                addChatMessage('ai', `–ò–∑–≤–∏–Ω–∏, –Ω–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${error.message}`);
                diagnoseError(error.message, 'Chat');
            }
            
            sendBtn.disabled = false;
            sendBtn.textContent = '‚û§';
        }

        function clearChat() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <div class="text-4xl mb-2">ü§ñ</div>
                    <div class="text-sm">–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ó–∞–¥–∞–π –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å!</div>
                </div>
            `;
            conversationId = null;
            addLog('–ß–∞—Ç –æ—á–∏—â–µ–Ω', 'info');
        }

        // ==================== Initialize ====================
        addLog('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (v10-upload-fix)', 'success');
        addLog('üéâ Session 20: Signed URL Pattern implemented!', 'success');
        addLog('‚ú® NEW: Secure file upload directly to GCS', 'info');
        addLog('‚ú® Feedback buttons available (üëçüëéüîÑ)', 'info');
    </script>
</body>
</html>
